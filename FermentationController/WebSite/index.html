<!DOCTYPE html>
<html>
<head>
<title>Fermentation Monitor</title>
<link rel="stylesheet" type="text/css" href="css/fermctrl.css"/>
</head>
 
<body onload="connect()">

<script src="common.js"></script>

<script>

  var wWebSocket;

  function connect()
  {
    try
    {
      if (typeof QueryString.server != 'undefined')
        wWebSocket = new WebSocket(QueryString.server);
      else
        wWebSocket = new WebSocket("wss://" + window.location.hostname + "/wsfermctrl");
    }
    catch (exc)
    {
      console.log(exc.message);
    }
    wWebSocket.onmessage = function (evt) { parseMessage(evt); };
  }

  function parseMessage(evt)
  {
    console.log(evt.data);
    var wCommand = evt.data.split("|");
    if (wCommand.length == 2)
    {
      if (wCommand[0] == "now_data")
      {
        handleNowData(wCommand[1].split(","))
      } 
    }
  }

  function handleNowData(data)
  {
    var wort_temperature = document.getElementById("wort_temperature");
    wort_temperature.innerHTML = Number(data[0]).toFixed(1);

    var air_temperature = document.getElementById("air_temperature");
    air_temperature.innerHTML = Number(data[1]).toFixed(1);

    var actual_relative_humidity = document.getElementById("actual_relative_humidity");
    actual_relative_humidity.innerHTML = (Number(data[2])).toFixed(1);

    switch (Number(data[4]))
    {
    case 0:
      document.getElementById("actual_cooler_status").style.background = "red";
      document.getElementById("actual_cooler_status").innerHTML = "OFF";
      break;
    case 1:
      document.getElementById("actual_cooler_status").style.background = "green";
      document.getElementById("actual_cooler_status").innerHTML = "ON";
      break;
    }
  }
</script>

<table style="width: 100%;">
  <tr class="top_table_tr">
    <th class="top_table_th">Wort Temperature</th>
    <th class="top_table_th">Air Temperature</th>
  </tr>
  <tr>
    <td class="text_data">
      <table style="width: 100%;">
        <tr>
          <td id="wort_temperature" class="top_fields"></td>
          <td id="wort_temperature_degree_c" class="degree_c">&deg;C</td>
        </tr>
      </table>
    </td>
    <td class="text_data">
      <table style="width: 100%;">
        <tr>
          <td id="air_temperature" class="top_fields"></td>
          <td class="degree_c">&deg;C</td>
        </tr>
      </table>
    </td>
  </tr>
  
  <tr class="top_table_tr">
    <th class="top_table_th">Relative Humidity</th>
    <th class="top_table_th">Cooler Status</th>
  </tr>
  <tr>
    <td class="text_data">
      <table style="width: 100%;">
        <tr>
          <td id="actual_relative_humidity" class="top_fields"></td>
          <td class="pct">%</td>
        </tr>
      </table>
    </td>
    <td class="text_data">
      <table style="width: 100%;">
        <tr>
          <td id="actual_cooler_status" class="top_fields"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>

</body>
</html>
