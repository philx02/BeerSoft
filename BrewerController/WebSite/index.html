<!DOCTYPE html>
<html>
<head>
<title>Brewer Control</title>
<link rel="stylesheet" type="text/css" href="css/brewer.css"/>
</head>
 
<body onload="connect()">

<script src="common.js"></script>

<script>

  var wWebSocket;

  function connect()
  {
    try
    {
      wWebSocket = new WebSocket(QueryString.server);
    }
    catch (exc)
    {
      console.log(exc.message);
    }
    wWebSocket.onopen = function (evt) { greetings(evt); };
    wWebSocket.onmessage = function (evt) { parseMessage(evt); };
  }

  function greetings(evt)
  {
    wWebSocket.send("get_status");
  }

  function parseMessage(evt)
  {
    console.log(evt.data);
    var wSplit = evt.data.split(",");

    var temperature_command = document.getElementById("temperature_command");
    temperature_command.innerHTML = Number(wSplit[0]).toFixed(1);

    var actual_temperature = document.getElementById("actual_temperature");
    actual_temperature.innerHTML = Number(wSplit[1]).toFixed(1);

    var actual_duty_cycle = document.getElementById("actual_duty_cycle");
    actual_duty_cycle.innerHTML = (100.0 * Number(wSplit[2])).toFixed(1);

    switch (Number(wSplit[3]))
    {
      case 0:
        document.getElementById("off_button").style.background = "red";
        document.getElementById("pwm_button").style.background = "grey";
        document.getElementById("always_on_button").style.background = "grey";
        break;
      case 1:
        document.getElementById("off_button").style.background = "grey";
        document.getElementById("pwm_button").style.background = "red";
        document.getElementById("always_on_button").style.background = "grey";
        break;
      case 2:
        document.getElementById("off_button").style.background = "grey";
        document.getElementById("pwm_button").style.background = "grey";
        document.getElementById("always_on_button").style.background = "red";
        break;
    }
  }

  function toggle_visibility(id)
  {
    var e = document.getElementById(id);
    if (e.style.display == 'block')
    {
      e.style.display = 'none';
      document.body.style.backgroundColor = "white";
    }
    else
    {
      e.style.display = 'block';
      document.body.style.backgroundColor = "grey";
    }
  }

  function submitCommand()
  {
    toggle_visibility('enter_temperature_command');
    wWebSocket.send("set_command," + document.getElementById("input_temperature_command").value);
  }

  function setMode(mode)
  {
    wWebSocket.send("set_mode," + mode);
  }

  function checkKey()
  {
    console.log(event.keyCode);
    /*if (event.keyCode == 13)
    {
      submitCommand();
    }
    else */if (event.keyCode == 27)
    {
      toggle_visibility('enter_temperature_command');
    }
  }
</script>

<table>
  <tr class="top_table_tr">
    <th class="top_table_th">Temperature Command</th>
    <th class="top_table_th">Measured Temperature</th>
  </tr>
  <tr>
    <td class="text_data">
      <table>
        <tr>
          <td id="temperature_command" class="temperature" onclick="toggle_visibility('enter_temperature_command'); document.getElementById('input_temperature_command').value=''; document.getElementById('input_temperature_command').focus();"></td>
          <td class="degree_c">&deg;C</td>
        </tr>
      </table>
    </td>
    <td class="text_data">
      <table>
        <tr>
          <td id="actual_temperature" class="temperature"></td>
          <td class="degree_c">&deg;C</td>
        </tr>
      </table>
    </td>
  </tr>
  
  <tr class="top_table_tr">
    <th class="top_table_th">Duty Cycle</th>
  </tr>
  <tr>
    <td class="text_data" colspan="2">
      <table>
        <tr>
          <td id="actual_duty_cycle" class="duty_cycle"></td>
          <td class="pct">%</td>
        </tr>
      </table>
    </td>
  </tr>
</table>

<table id="bottom_buttons">
  <tr>
    <td class="mode_button_td"><input id="always_on_button" class="mode_button" type="button" value="ALWAYS ON" onclick="setMode(2);" /></td>
    <td class="mode_button_td"><input id="pwm_button" class="mode_button" type="button" value="PWM" onclick="setMode(1);" /></td>
    <td class="mode_button_td"><input id="off_button" class="mode_button" type="button" value="OFF" onclick="setMode(0);" /></td>
  </tr>
</table>

<div id="enter_temperature_command">
  <form onsubmit="submitCommand(); return false;">
    <input id="input_temperature_command" type="number" onkeydown="checkKey();" />
    <input class="input_temperature_command_button" type="submit" />
    <input class="input_temperature_command_button" type="button" value="Cancel" onclick="toggle_visibility('enter_temperature_command');" />
  </form>
</div>

</body>
</html>
