<!DOCTYPE html>
<html>
<head>
<title>Kegerator Monitor</title>
<link rel="stylesheet" type="text/css" href="css/kegerator.css"/>
</head>
 
<body onload="connect()">

<script src="common.js"></script>

<script>

  var wWebSocket;

  function connect()
  {
    drawKegLevel(0, 0.3, 'yellow');
    drawKegLevel(1, 0.7, 'brown');
    drawCo2Level(.39);
    temperature_data.innerHTML = 4.2;
    try
    {
      wWebSocket = new WebSocket(QueryString.server);
    }
    catch (exc)
    {
      console.log(exc.message);
    }
    wWebSocket.onopen = function (evt) { greetings(evt); };
    wWebSocket.onmessage = function (evt) { parseMessage(evt); };
  }

  function greetings(evt)
  {
    wWebSocket.send("get_status");
  }

  function parseMessage(evt)
  {
    var wSplit = evt.data.split(",");

    var temperature_data = document.getElementById("temperature_data");
    temperature_data.innerHTML = Number(wSplit[0]).toFixed(1);

    var pressure_data = document.getElementById("pressure_data");
    pressure_data.innerHTML = (Number(wSplit[1])/1000).toFixed(1);
    
    drawCo2Level(Number(wSplit[2]));
    drawKegLevel(0, Number(wSplit[3]), wSplit[4]);
    drawKegLevel(1, Number(wSplit[5]), wSplit[6]);
  }

  function drawCo2Level(level_pct)
  {
    var canvas = document.getElementById('co2_level');
    var context = canvas.getContext('2d');
    context.beginPath();
    var level_px = 149 * level_pct;
    context.rect(9, 10, level_px, 40);
    if (level_pct < 0.15)
    {
      context.fillStyle = 'red';
    }
    else if (level_pct < 0.4)
    {
      context.fillStyle = 'orange';
    }
    else
    {
      context.fillStyle = 'green';
    }
    context.fill();
  }

  function drawKegLevel(keg_id, level_pct, color)
  {
    var canvas = document.getElementById('beer_level_keg_' + keg_id);
    var context = canvas.getContext('2d');
    context.beginPath();
    var level_px = -420 * level_pct + 522;
    context.rect(25, level_px, 150, 522 - level_px);
    context.fillStyle = color;
    context.fill();
  }
</script>

<table>
  <tr>

    <td class="text_data">
      <table>
        <tr>
          <td id="temperature_data" class="temperature"></td>
          <td class="degree_c">&deg;C</td>
        </tr>
        <tr>
          <td colspan="2">
            <div class="parent">
              <img src="Co2TankEmpty.png" width="200"/>
              <canvas id="co2_level"></canvas>
            </div>
          </td>
        </tr>
      </table>
    </td>

    <td class="keg_left">
      <div class="parent">
        <img src="KegEmpty.png" height="280" />
        <canvas id="beer_level_keg_0" class="beer_level"></canvas>
      </div>
    </td>

    <td class="keg_right">
      <div class="parent">
        <img src="KegEmpty.png" height="280" />
        <canvas id="beer_level_keg_1" class="beer_level"></canvas>
      </div>
    </td>

  </tr>
</table>

</body>
</html>
