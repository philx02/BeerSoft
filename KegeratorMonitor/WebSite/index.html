<!DOCTYPE html>
<html>
<head>
<title>Kegerator Monitor</title>
<link rel="stylesheet" type="text/css" href="css/kegerator.css"/>
</head>
 
<body onload="start()">

<script src="common.js"></script>

<script>

  var wWebSocket;
  var tday = new Array("Dim", "Lun", "Mar", "Mer", "Jeu", "Ven", "Sam");
  var tmonth = new Array("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec");

  function start()
  {
    getClock();
    setInterval(getClock, 1000);
    //drawKegLevel(0, 0.3, 'yellow');
    //drawKegLevel(1, 0.7, 'brown');
    //drawCo2Level(.39);
    //temperature_data.innerHTML = 4.2;
    try
    {
      wWebSocket = new WebSocket(QueryString.server);
    }
    catch (exc)
    {
      console.log(exc.message);
    }
    wWebSocket.onopen = function (evt) { greetings(evt); };
    wWebSocket.onmessage = function (evt) { parseMessage(evt); };
  }

  function getClock()
  {
    var d=new Date();
    var nday=d.getDay(),nmonth=d.getMonth(),ndate=d.getDate();
    var nhour=d.getHours(),nmin=d.getMinutes();
    if(nmin<=9) nmin="0"+nmin

    document.getElementById('clockbox').innerHTML = "" + tday[nday] +/*", "+tmonth[nmonth]+*/" " + ndate + ", " + nhour + ":" + nmin + "";
  }

  function greetings(evt)
  {
    wWebSocket.send("get_status");
  }

  function parseMessage(evt)
  {
    console.log(evt.data);
    var wSplit = evt.data.split(",");

    var temperature_data = document.getElementById("temperature_data");
    temperature_data.innerHTML = Number(wSplit[0]).toFixed(1);

    //var pressure_data = document.getElementById("pressure_data");
    //pressure_data.innerHTML = (Number(wSplit[1])/1000).toFixed(1);
    
    drawCo2Level(Number(wSplit[2]));
    drawKegLevel(0, Number(wSplit[4]), '#cc9900');
    drawKegLevel(1, Number(wSplit[3]), 'yellow');
  }

  function drawCo2Level(level_pct)
  {
    var canvas = document.getElementById('co2_level');
    var context = canvas.getContext('2d');
    context.beginPath();
    context.clearRect(0, 0, canvas.width, canvas.height);
    var factor = 2.5;
    var level_px = (factor * 149) * level_pct;
    var bottom_level_px = factor * 9;
    context.rect(bottom_level_px, 10, level_px, 120);
    if (level_pct < 0.15)
    {
      context.fillStyle = 'red';
    }
    else if (level_pct < 0.4)
    {
      context.fillStyle = 'orange';
    }
    else
    {
      context.fillStyle = 'green';
    }
    context.fill();
  }

  function drawKegLevel(keg_id, level_pct, color)
  {
    var canvas = document.getElementById('beer_level_keg_' + keg_id);
    var context = canvas.getContext('2d');
    context.clearRect(0, 0, canvas.width, canvas.height);
    context.beginPath();
    var zoom_factor = 1.75;
    var level_px = -(zoom_factor*203) * level_pct + (zoom_factor*252);
    var bottom_level_px = (zoom_factor*260) - level_px;
    context.rect(20, level_px, 125, bottom_level_px);
    context.fillStyle = color;
    context.fill();
  }
</script>

<table>
  <tr>

    <td class="text_data" id="left_col">
      <table>
        <tr>
          <td colspan="2" id="clockbox" class="clock"></td>
        </tr>
        <tr>
          <td id="temperature_data" class="temperature"></td>
          <td class="degree_c">&deg;C</td>
        </tr>
        <tr>
          <td colspan="2">
            <div class="parent">
              <img src="Co2TankEmpty.png" width="490"/>
              <canvas id="co2_level" height="150"></canvas>
            </div>
          </td>
        </tr>
      </table>
    </td>

    <td class="keg_left" id="middle_col">
      <table>
        <tr>
          <td colspan="2" class="keg_left_title">
            Wounded<br />Knee IPA
          </td>
        </tr>
        <tr>
          <td>
            <table class="beer_details">
              <tr>
                <td>
                  IBU<br />56
                </td>
              </tr>
              <tr>
                <td>
                  ABV<br />4.8%
                </td>
              </tr>
            </table>
          </td>
          <td>
            <div class="parent">
              <img src="KegEmpty.png" height="500" />
              <canvas id="beer_level_keg_0" class="beer_level" height="500" width="130"></canvas>
            </div>
          </td>
        </tr>
      </table>
    </td>

    <td class="keg_right">
      <table>
        <tr>
          <td colspan="2" class="keg_right_title">
            Blonde<br />Facile
          </td>
        </tr>
        <tr>
          <td>
            <table class="beer_details">
              <tr>
                <td>
                  IBU<br />39
                </td>
              </tr>
              <tr>
                <td>
                  ABV<br />5.1%
                </td>
              </tr>
            </table>
          </td>
          <td>
            <div class="parent">
              <div class="keg_picture">
                <img src="KegEmpty.png" height="500" />
              </div>
              <canvas id="beer_level_keg_1" class="beer_level" height="500" width="130"></canvas>
            </div>
          </td>
        </tr>
      </table>

    </tr>
  </table>

</body>
</html>
